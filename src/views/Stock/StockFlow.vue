<template>
  <div class="stock-flow">
    <!-- 搜索过滤区域 -->
    <div class="search-bar">
      <div class="row q-col-gutter-sm items-center">
        <!-- 时间筛选+类型 -->
        <DatePickerNew
          v-model:start_date="filters.start_date"
          v-model:end_date="filters.end_date"
          :showSelect="false"
        ></DatePickerNew>

        <!-- 关键词搜索模块 -->
        <KeywordSearch
          v-model:search_mode="filters.search_mode"
          v-model:search_type="filters.search_type"
          v-model:search_value="filters.keywords"
          :searchTypeList="searchTypeOptions"
        ></KeywordSearch>

        <div>
          <q-btn color="primary" class="filter-btn" :label="t('搜索')" @click="handleSearch" />
        </div>
      </div>
    </div>

    <!-- 表格 -->
    <div class="main-table">
      <!-- 导出按钮 -->
      <div class="q-py-md">
        <q-btn color="primary" :label="t('导出')" flat icon="file_download" @click="handleExport" />
      </div>
      <q-table
        :rows="tableData"
        :columns="columns"
        row-key="id"
        flat
        :rows-per-page-options="[10, 20, 50]"
        v-model:pagination="tablePagination"
        hide-pagination
        :loading="loading"
      >
        <template v-slot:no-data="{ icon, filter }">
          <div class="full-width row flex-center text-grey-6 q-gutter-sm">
            <q-icon size="2em" :name="filter ? 'filter_b_and_w' : icon" />
            <span>{{ t('暂无数据') }}</span>
          </div>
        </template>
        <template v-slot:body="props">
          <q-tr :props="props">
            <q-td key="time" :props="props">
              {{ props.row.created_at }}
            </q-td>
            <q-td key="product" :props="props">
              <div class="row items-center">
                <q-img
                  v-if="props.row.product_spec_image"
                  :src="props.row.product_spec_image"
                  style="width: 40px; height: 40px; object-fit: cover"
                  class="q-mr-sm"
                />
                <div>
                  <div>{{ props.row.sku }}</div>
                  <div>{{ props.row.product_name }}</div>
                  <div class="text-grey-7">{{ props.row.name }}</div>
                </div>
              </div>
            </q-td>
            <q-td key="change_qty" :props="props">
              <span :class="props.row.stock > 0 ? 'text-green' : 'text-red'">
                {{ props.row.stock > 0 ? '+' : '' }}{{ props.row.stock }}
              </span>
            </q-td>
            <q-td key="total_qty" :props="props">
              {{ props.row.stock_after }}
            </q-td>
            <q-td key="type" :props="props">
              {{ props.row.type }}
            </q-td>
            <q-td key="reference" :props="props">
              <template v-if="props.row.type === '销售出库'">
                <div class="text-grey-7">{{ t('ERP包裹号') }}:</div>
                <div>
                  <span class="hover-copy" @click="$copy(props.row.reference_number)">
                    {{ props.row.reference_number || '--' }}
                  </span>
                </div>
                <div class="text-grey-7">{{ t('订单号') }}: {{ props.row.order_no || '--' }}</div>
                <div class="text-grey-7">{{ t('运单号') }}: {{ props.row.tracking_no || '--' }}</div>
              </template>
              <template v-else>
                <div>
                  {{ t('调整单号') }}:
                  <span class="hover-copy" @click="$copy(props.row.reference_number)">
                    {{ props.row.reference_number || '--' }}
                  </span>
                </div>
                <div>{{ t('入库批次号') }}: {{ props.row.inbound_batch_number || '--' }}</div>
                <div>{{ t('库位') }}: {{ props.row.warehouse_location_code || '--' }}</div>
              </template>
            </q-td>
          </q-tr>
        </template>

        <!-- 分页 -->
        <template v-slot:bottom>
          <div class="row items-center justify-end q-pa-sm full-width">
            <Pagination
              :total-count="pagination.total"
              v-model:page="pagination.page"
              :max-page="pagination.maxPage"
              v-model:rows-per-page="pagination.rowsPerPage"
              @page-change="handlePageChange"
            />
          </div>
        </template>
      </q-table>
    </div>
  </div>
</template>

<script setup>
import api from '@/api/index';
import DatePickerNew from '@/components/DatePickerNew/Index.vue';
import KeywordSearch from '@/components/KeywordSearch/Index.vue';
import Pagination from '@/components/Pagination.vue';
import { useQuasar } from 'quasar';
import { onMounted, ref } from 'vue';
import { useI18n } from 'vue-i18n';

const { t } = useI18n();
const $q = useQuasar();

// 筛选条件
const filters = ref({
  start_date: '',
  end_date: '',
  search_type: 'sku',
  keywords: '',
  search_mode: 'exact',
});

// 搜索类型选项
const searchTypeOptions = [
  { label: 'SKU', value: 'sku' },
  { label: t('商品名称'), value: 'product_name' },
];

// 搜索模式选项
const searchModeOptions = [
  { label: t('精确搜索'), value: 'exact' },
  { label: t('前缀搜索'), value: 'prefix' },
  { label: t('模糊搜索'), value: 'fuzzy' },
];

// 表格列定义
const columns = [
  {
    name: 'time',
    label: t('时间'),
    field: 'created_at',
    align: 'left',
    style: 'width:15%',
  },
  {
    name: 'product',
    label: t('商品信息'),
    field: 'product',
    align: 'left',
    style: 'width:20%',
  },
  {
    name: 'change_qty',
    label: t('变化数量'),
    field: 'stock',
    align: 'center',
    style: 'width:10%',
  },
  {
    name: 'total_qty',
    label: t('变动后库存总量'),
    field: 'stock_after',
    align: 'center',
    style: 'width:15%',
  },
  {
    name: 'type',
    label: t('类型'),
    field: 'type',
    align: 'center',
    style: 'width:15%',
  },
  {
    name: 'reference',
    label: t('关联单据号'),
    field: 'reference',
    align: 'left',
    style: 'width:25%',
  },
];

const loading = ref(false);

// 分页配置
const pagination = ref({
  page: 1,
  maxPage: 1,
  rowsPerPage: 50,
  total: 5,
});

// 表格分页配置
const tablePagination = ref({
  sortBy: '',
  descending: false,
  page: 1,
  rowsPerPage: 0,
});

// 获取数据
const fetchData = async () => {
  try {
    loading.value = true;
    const params = {
      page: pagination.value.page,
      page_size: pagination.value.rowsPerPage,
      search_type: filters.value.search_type,
      keywords: filters.value.keywords,
      search_mode: filters.value.search_mode,
      start_date: filters.value.start_date,
      end_date: filters.value.end_date,
    };

    const response = await api.getStocksLogList(params);
    if (response?.success) {
      tableData.value = response.data.items;
      // 更新分页信息
      const meta = response.data.meta;
      pagination.value = {
        page: meta.current_page,
        maxPage: meta.last_page,
        rowsPerPage: meta.per_page,
        total: meta.total,
      };
    }
  } catch (error) {
    console.error('获取库存流水失败:', error);
    $q.notify({
      message: t('获取库存流水失败'),
      color: 'negative',
    });
  } finally {
    loading.value = false;
  }
};

// 处理搜索
const handleSearch = () => {
  pagination.value.page = 1;
  fetchData();
};

// 处理分页变更
const handlePageChange = ({ page, rowsPerPage }) => {
  pagination.value.page = page;
  pagination.value.rowsPerPage = rowsPerPage;
  fetchData();
};

// 组件挂载时获取数据
onMounted(() => {
  fetchData();
});

// 模拟数据
const tableData = ref([]);

// 处理导出
const handleExport = () => {
  console.log('导出数据');
  // TODO: 实现导出逻辑
};
</script>

<style lang="scss" scoped>
.stock-flow {
}
</style>
